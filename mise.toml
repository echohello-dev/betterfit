[tasks.test]
run = "swift test"

[tasks.build]
run = "swift build"

[tasks."ios:gen"]
run = "cd Apps/iOS && xcodegen generate"

[tasks."ios:open"]
run = "cd Apps/iOS && xcodegen generate && open BetterFit.xcodeproj"

[tasks."watch:gen"]
run = "cd Apps/iOS && xcodegen generate"

[tasks."watch:open"]
run = "cd Apps/iOS && xcodegen generate && open BetterFit.xcodeproj"

[tasks."watch:build"]
run = """
cd Apps/iOS
xcodegen generate

UDID=$(python3 - <<'PY'
import json, subprocess

runtime = "com.apple.CoreSimulator.SimRuntime.watchOS-11-2"
data = json.loads(subprocess.check_output(["xcrun", "simctl", "list", "devices", "available", "-j"]))
devices = data.get("devices", {}).get(runtime, [])

preferred = [
	"Apple Watch Series 10 (46mm)",
	"Apple Watch Series 10 (42mm)",
	"Apple Watch Ultra 2 (49mm)",
]

def pick(devs):
	for name in preferred:
		for d in devs:
			if d.get("name") == name:
				return d.get("udid")
	for d in devs:
		if "Apple Watch" in (d.get("name") or ""):
			return d.get("udid")
	return (devs[0].get("udid") if devs else "")

print(pick(devices))
PY
)

if [ -n "$UDID" ]; then
  xcodebuild -project BetterFit.xcodeproj -scheme BetterFitWatch -destination "id=$UDID" build
else
  xcodebuild -project BetterFit.xcodeproj -scheme BetterFitWatch -destination 'generic/platform=watchOS Simulator' build
fi
"""

[tasks."ios:build:prod"]
run = """
cd Apps/iOS
xcodegen generate

UDID=$(python3 - <<'PY'
import json, subprocess

runtime = "com.apple.CoreSimulator.SimRuntime.iOS-26-2"
data = json.loads(subprocess.check_output(["xcrun", "simctl", "list", "devices", "available", "-j"]))
devices = data.get("devices", {}).get(runtime, [])

preferred = [
	"iPhone 16",
	"iPhone 16 Pro",
	"iPhone 16 Plus",
	"iPhone 16 Pro Max",
]

def pick(devs):
	for name in preferred:
		for d in devs:
			if d.get("name") == name:
				return d.get("udid")
	for d in devs:
		if "iPhone" in (d.get("name") or ""):
			return d.get("udid")
	return (devs[0].get("udid") if devs else "")

print(pick(devices))
PY
)

if [ -n "$UDID" ]; then
  xcodebuild -project BetterFit.xcodeproj -scheme BetterFit -destination "id=$UDID" build
else
  xcodebuild -project BetterFit.xcodeproj -scheme BetterFit -destination 'generic/platform=iOS Simulator' build
fi
"""

[tasks."ios:build:dev"]
run = """
cd Apps/iOS
xcodegen generate

UDID=$(python3 - <<'PY'
import json, subprocess

runtime = "com.apple.CoreSimulator.SimRuntime.iOS-26-2"
data = json.loads(subprocess.check_output(["xcrun", "simctl", "list", "devices", "available", "-j"]))
devices = data.get("devices", {}).get(runtime, [])

preferred = [
	"iPhone 16",
	"iPhone 16 Pro",
	"iPhone 16 Plus",
	"iPhone 16 Pro Max",
]

def pick(devs):
	for name in preferred:
		for d in devs:
			if d.get("name") == name:
				return d.get("udid")
	for d in devs:
		if "iPhone" in (d.get("name") or ""):
			return d.get("udid")
	return (devs[0].get("udid") if devs else "")

print(pick(devices))
PY
)

if [ -n "$UDID" ]; then
  xcodebuild -project BetterFit.xcodeproj -scheme BetterFitDev -destination "id=$UDID" build
else
  xcodebuild -project BetterFit.xcodeproj -scheme BetterFitDev -destination 'generic/platform=iOS Simulator' build
fi
"""

[tasks."ios:sim:boot26"]
run = """
set -euo pipefail

UDID=$(python3 - <<'PY'
import json, subprocess

runtime = "com.apple.CoreSimulator.SimRuntime.iOS-26-2"
data = json.loads(subprocess.check_output(["xcrun", "simctl", "list", "devices", "available", "-j"]))
devices = data.get("devices", {}).get(runtime, [])

preferred = [
	"iPhone 16",
	"iPhone 16 Pro",
	"iPhone 16 Plus",
	"iPhone 16 Pro Max",
]

def pick(devs):
	for name in preferred:
		for d in devs:
			if d.get("name") == name:
				return d.get("udid")
	for d in devs:
		if "iPhone" in (d.get("name") or ""):
			return d.get("udid")
	return (devs[0].get("udid") if devs else "")

print(pick(devices))
PY
)

if [ -z "$UDID" ]; then
  echo "No iOS 26.2 simulator runtime/devices found. Install iOS 26.2 Simulator runtime in Xcode Settings > Platforms." >&2
  exit 1
fi

xcrun simctl boot "$UDID" 2>/dev/null || true
xcrun simctl bootstatus "$UDID" -b
open -a Simulator --args -CurrentDeviceUDID "$UDID"
"""

[tasks."ios:sim:reset"]
run = """
killall -9 Simulator 2>/dev/null || true
killall -9 CoreSimulatorService 2>/dev/null || true
killall -9 com.apple.CoreSimulator.CoreSimulatorService 2>/dev/null || true
xcrun simctl shutdown all || true
"""
