[tasks.test]
run = "swift test"

[tasks.build]
run = "swift build"

[tasks."ios:gen"]
run = "cd Apps/iOS && xcodegen generate"

[tasks."ios:open"]
run = "cd Apps/iOS && xcodegen generate && open BetterFit.xcodeproj"

[tasks."watch:gen"]
run = "cd Apps/iOS && xcodegen generate"

[tasks."watch:open"]
run = "cd Apps/iOS && xcodegen generate && open BetterFit.xcodeproj"

[tasks."watch:build"]
run = """
cd Apps/iOS
xcodegen generate

UDID=$(python3 "$PWD/scripts/simctl_pick_udid.py" \
  --runtime "com.apple.CoreSimulator.SimRuntime.watchOS-11-2" \
  --prefer "Apple Watch Series 10 (46mm)" \
  --prefer "Apple Watch Series 10 (42mm)" \
  --prefer "Apple Watch Ultra 2 (49mm)" \
  --contains "Apple Watch")

if [ -n "$UDID" ]; then
  xcodebuild -project BetterFit.xcodeproj -scheme BetterFitWatch -destination "id=$UDID" build
else
  xcodebuild -project BetterFit.xcodeproj -scheme BetterFitWatch -destination 'generic/platform=watchOS Simulator' build
fi
"""

[tasks."ios:build:prod"]
run = """
cd Apps/iOS
xcodegen generate

UDID=$(python3 "$PWD/scripts/simctl_pick_udid.py" \
  --runtime "com.apple.CoreSimulator.SimRuntime.iOS-26-2" \
  --prefer "iPhone 16" \
  --prefer "iPhone 16 Pro" \
  --prefer "iPhone 16 Plus" \
  --prefer "iPhone 16 Pro Max" \
  --contains "iPhone")

if [ -n "$UDID" ]; then
  xcodebuild -project BetterFit.xcodeproj -scheme BetterFit -destination "id=$UDID" build
else
  xcodebuild -project BetterFit.xcodeproj -scheme BetterFit -destination 'generic/platform=iOS Simulator' build
fi
"""

[tasks."ios:build:dev"]
run = """
cd Apps/iOS
xcodegen generate

UDID=$(python3 "$PWD/scripts/simctl_pick_udid.py" \
  --runtime "com.apple.CoreSimulator.SimRuntime.iOS-26-2" \
  --prefer "iPhone 16" \
  --prefer "iPhone 16 Pro" \
  --prefer "iPhone 16 Plus" \
  --prefer "iPhone 16 Pro Max" \
  --contains "iPhone")

if [ -n "$UDID" ]; then
  xcodebuild -project BetterFit.xcodeproj -scheme BetterFitDev -destination "id=$UDID" build
else
  xcodebuild -project BetterFit.xcodeproj -scheme BetterFitDev -destination 'generic/platform=iOS Simulator' build
fi
"""

[tasks."ios:sim:boot26"]
run = """
set -euo pipefail

UDID=$(python3 "$PWD/scripts/simctl_pick_udid.py" \
  --runtime "com.apple.CoreSimulator.SimRuntime.iOS-26-2" \
  --prefer "iPhone 16" \
  --prefer "iPhone 16 Pro" \
  --prefer "iPhone 16 Plus" \
  --prefer "iPhone 16 Pro Max" \
  --contains "iPhone")

if [ -z "$UDID" ]; then
  echo "No iOS 26.2 simulator runtime/devices found. Install iOS 26.2 Simulator runtime in Xcode Settings > Platforms." >&2
  exit 1
fi

xcrun simctl boot "$UDID" 2>/dev/null || true
xcrun simctl bootstatus "$UDID" -b
open -a Simulator --args -CurrentDeviceUDID "$UDID"
"""

[tasks."ios:sim:reset"]
run = """
killall -9 Simulator 2>/dev/null || true
killall -9 CoreSimulatorService 2>/dev/null || true
killall -9 com.apple.CoreSimulator.CoreSimulatorService 2>/dev/null || true
xcrun simctl shutdown all || true
"""

[tasks."watch:sim:boot"]
run = """
set -euo pipefail

IOS_UDID=$(python3 "$PWD/scripts/simctl_pick_udid.py" \
  --runtime "com.apple.CoreSimulator.SimRuntime.iOS-26-2" \
  --prefer "iPhone 16" \
  --prefer "iPhone 16 Pro" \
  --prefer "iPhone 16 Plus" \
  --prefer "iPhone 16 Pro Max" \
  --contains "iPhone")

WATCH_UDID=$(python3 "$PWD/scripts/simctl_pick_udid.py" \
  --runtime "com.apple.CoreSimulator.SimRuntime.watchOS-26-2" \
  --prefer "Apple Watch Series 10 (46mm)" \
  --prefer "Apple Watch Series 10 (42mm)" \
  --prefer "Apple Watch Ultra 2 (49mm)" \
  --contains "Apple Watch")

if [ -z "$WATCH_UDID" ]; then
	echo "No watchOS 26.2 simulator runtime/devices found. Install watchOS Simulator runtime in Xcode Settings > Platforms." >&2
  exit 1
fi

if [ -n "$IOS_UDID" ]; then
  xcrun simctl boot "$IOS_UDID" 2>/dev/null || true
  xcrun simctl bootstatus "$IOS_UDID" -b
fi

xcrun simctl boot "$WATCH_UDID" 2>/dev/null || true
xcrun simctl bootstatus "$WATCH_UDID" -b
open -a Simulator --args -CurrentDeviceUDID "$WATCH_UDID"
"""
